================================================================================
FLUXO COMPLETO: CLONAGEM Ã‰TICA DE LINKS ML
================================================================================

CENÃRIO: Mensagem com link de afiliado detectada no WhatsApp

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 1: DETECÃ‡ÃƒO                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ“± WhatsApp Monitor (Node.js)                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ server.js - Listener de mensagens                            â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚  sock.ev.on('messages.upsert', async ({ messages }) => {     â”‚         â”‚
â”‚  â”‚    const text = extractText(message);                        â”‚         â”‚
â”‚  â”‚    const imageUrl = extractImage(message);                   â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚    // Mensagem capturada:                                    â”‚         â”‚
â”‚  â”‚    // "ğŸ”¥ Oferta TOP!                                        â”‚         â”‚
â”‚  â”‚    //  https://mercadolivre.com/sec/1citUM9"                 â”‚         â”‚
â”‚  â”‚  });                                                          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚                             â¬‡ï¸                                             â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“¤ POST para Flask API                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Endpoint: /whatsapp/clone-message                            â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚ Body: {                                                       â”‚         â”‚
â”‚  â”‚   "mensagem": "ğŸ”¥ Oferta TOP!                                â”‚         â”‚
â”‚  â”‚                https://mercadolivre.com/sec/1citUM9",        â”‚         â”‚
â”‚  â”‚   "imagem_url": "data:image/jpeg;base64,...",                â”‚         â”‚
â”‚  â”‚   "grupo_origem": "123456789@g.us",                          â”‚         â”‚
â”‚  â”‚   "grupo_origem_nome": "PromoÃ§Ãµes Top"                       â”‚         â”‚
â”‚  â”‚ }                                                             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â¬‡ï¸

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 2: PROCESSAMENTO DE LINKS                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ Flask (Python) - routes.py                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ def clone_message_with_affiliate():                          â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # 1. Recebe mensagem                                       â”‚         â”‚
â”‚  â”‚   mensagem = data.get('mensagem')                            â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # 2. Chama substituidor de links                           â”‚         â”‚
â”‚  â”‚   mensagem_nova, links = substituir_links_afiliado(mensagem) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚                             â¬‡ï¸                                             â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“ FunÃ§Ã£o: substituir_links_afiliado()                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ # Extrai todas as URLs da mensagem                           â”‚         â”‚
â”‚  â”‚ url_pattern = r'https?://[^\s<>"{}|\\^`\[\]]+'               â”‚         â”‚
â”‚  â”‚ urls = re.findall(url_pattern, mensagem)                     â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚ # Encontrado: https://mercadolivre.com/sec/1citUM9           â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚ # Detecta se Ã© link curto ML                                 â”‚         â”‚
â”‚  â”‚ if 'mercadolivre.com/sec/' in url:                           â”‚         â”‚
â”‚  â”‚   logger.info('ğŸ”— Link curto ML detectado!')                 â”‚         â”‚
â”‚  â”‚   # â¬‡ï¸ CHAMA EXPANSÃƒO                                        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â¬‡ï¸

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 3: EXPANSÃƒO DO LINK CURTO                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ”— ml_affiliate.py - expandir_link_curto_ml()                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ def expandir_link_curto_ml(short_url):                       â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # PASSO 1: Acessar link curto (gera comissÃ£o original)    â”‚         â”‚
â”‚  â”‚   response = requests.get(                                   â”‚         â”‚
â”‚  â”‚     "https://mercadolivre.com/sec/1citUM9",                  â”‚         â”‚
â”‚  â”‚     allow_redirects=True                                     â”‚         â”‚
â”‚  â”‚   )                                                           â”‚         â”‚
â”‚  â”‚   # âœ… Criador original recebe comissÃ£o pelo clique!         â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # PASSO 2: Parsear HTML da pÃ¡gina social                   â”‚         â”‚
â”‚  â”‚   soup = BeautifulSoup(response.content, 'html.parser')      â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # PASSO 3: Buscar botÃ£o "Ir para o produto"               â”‚         â”‚
â”‚  â”‚   seletores = [                                               â”‚         â”‚
â”‚  â”‚     '#root-app > ... > a',      # Seletor especÃ­fico         â”‚         â”‚
â”‚  â”‚     'a[href*="/p/MLB"]',        # Fallback 1                 â”‚         â”‚
â”‚  â”‚     'a[href*="/MLB-"]',         # Fallback 2                 â”‚         â”‚
â”‚  â”‚     '.poly-card__content a',    # Fallback 3                 â”‚         â”‚
â”‚  â”‚   ]                                                           â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   for seletor in seletores:                                  â”‚         â”‚
â”‚  â”‚     element = soup.select_one(seletor)                       â”‚         â”‚
â”‚  â”‚     if element and element.get('href'):                      â”‚         â”‚
â”‚  â”‚       product_link = element.get('href')                     â”‚         â”‚
â”‚  â”‚       # âœ… Encontrado!                                        â”‚         â”‚
â”‚  â”‚       break                                                   â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # Resultado: https://www.mercadolivre.com.br/p/MLB...      â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # PASSO 4: Limpar URL (remover rastreamento)              â”‚         â”‚
â”‚  â”‚   product_link = re.sub(r'[?&]tracking_id.*', '', ...)       â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   return product_link  # URL LIMPA DO PRODUTO                â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“Š Resultado da ExpansÃ£o                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Input:  https://mercadolivre.com/sec/1citUM9                 â”‚         â”‚
â”‚  â”‚ Output: https://www.mercadolivre.com.br/p/MLB123456789       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â¬‡ï¸

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 4: GERAÃ‡ÃƒO DE LINK DE AFILIADO                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ”— routes.py - aplicar_afiliado_ml()                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ # 1. Limpar parÃ¢metros do produto                            â”‚         â”‚
â”‚  â”‚ url_limpo = extrair_link_limpo_produto(url_produto_real)     â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚ # 2. Aplicar SEU afiliado                                    â”‚         â”‚
â”‚  â”‚ url_modificada = aplicar_afiliado_ml(url_limpo)              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚                             â¬‡ï¸                                             â”‚
â”‚                                                                            â”‚
â”‚  ğŸ”‘ ml_affiliate.py - generate_affiliate_link()                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ def generate_affiliate_link(product_url):                    â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # Headers com cookies + CSRF token                         â”‚         â”‚
â”‚  â”‚   headers = {                                                 â”‚         â”‚
â”‚  â”‚     'X-CSRF-Token': self.csrf_token,                         â”‚         â”‚
â”‚  â”‚     'Cookie': self.cookies,                                  â”‚         â”‚
â”‚  â”‚   }                                                           â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # Payload da API                                           â”‚         â”‚
â”‚  â”‚   payload = {                                                 â”‚         â”‚
â”‚  â”‚     "url": "https://www.mercadolivre.com.br/p/MLB123456789", â”‚         â”‚
â”‚  â”‚     "tag": "gabrielvilelaluiz",  # SEU ID de afiliado        â”‚         â”‚
â”‚  â”‚     "linkType": "SHORT_URL"                                  â”‚         â”‚
â”‚  â”‚   }                                                           â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # Chamar API do ML                                         â”‚         â”‚
â”‚  â”‚   response = requests.post(                                  â”‚         â”‚
â”‚  â”‚     "https://mercadolivre.com.br/.../createLink",            â”‚         â”‚
â”‚  â”‚     json=payload,                                            â”‚         â”‚
â”‚  â”‚     headers=headers                                          â”‚         â”‚
â”‚  â”‚   )                                                           â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # Extrair link curto                                       â”‚         â”‚
â”‚  â”‚   affiliate_link = response.json()['short_url']              â”‚         â”‚
â”‚  â”‚   # âœ… https://mercadolivre.com/sec/ABC123XYZ                â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   return affiliate_link  # SEU LINK DE AFILIADO!             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“Š Resultado                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Link original: https://mercadolivre.com/sec/1citUM9          â”‚         â”‚
â”‚  â”‚ Link produto:  https://mercadolivre.com.br/p/MLB123456789    â”‚         â”‚
â”‚  â”‚ SEU afiliado:  https://mercadolivre.com/sec/ABC123XYZ        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â¬‡ï¸

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 5: SUBSTITUIÃ‡ÃƒO NA MENSAGEM                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ“ routes.py - substituir_links_afiliado()                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ # Substituir link antigo pelo novo                           â”‚         â”‚
â”‚  â”‚ mensagem_modificada = mensagem.replace(                      â”‚         â”‚
â”‚  â”‚   url_original,   # https://mercadolivre.com/sec/1citUM9     â”‚         â”‚
â”‚  â”‚   url_modificada  # https://mercadolivre.com/sec/ABC123XYZ   â”‚         â”‚
â”‚  â”‚ )                                                             â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚ links_substituidos.append({                                  â”‚         â”‚
â”‚  â”‚   'plataforma': 'Mercado Livre (clonado)',                   â”‚         â”‚
â”‚  â”‚   'original': 'https://mercadolivre.com/sec/1citUM9',        â”‚         â”‚
â”‚  â”‚   'modificada': 'https://mercadolivre.com/sec/ABC123XYZ'     â”‚         â”‚
â”‚  â”‚ })                                                            â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“Š Mensagem Antes vs Depois                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ANTES:                                                        â”‚         â”‚
â”‚  â”‚ "ğŸ”¥ Oferta TOP!                                              â”‚         â”‚
â”‚  â”‚  https://mercadolivre.com/sec/1citUM9"                       â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚ DEPOIS:                                                       â”‚         â”‚
â”‚  â”‚ "ğŸ”¥ Oferta TOP!                                              â”‚         â”‚
â”‚  â”‚  https://mercadolivre.com/sec/ABC123XYZ"                     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â¬‡ï¸

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 6: AGENDAMENTO DE ENVIO                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ’¾ database.py - adicionar_mensagem_fila()                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ # 1. Upload de imagem para Supabase (se houver)             â”‚         â”‚
â”‚  â”‚ if imagem_url.startswith('data:image'):                      â”‚         â”‚
â”‚  â”‚   imagem_url = upload_imagem_whatsapp(imagem_url)            â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚ # 2. Calcular prÃ³ximo horÃ¡rio de envio (intervalo 5 min)    â”‚         â”‚
â”‚  â”‚ proxima_data = calcular_proximo_horario()                    â”‚         â”‚
â”‚  â”‚ # Ex: 2024-11-24 15:30:00                                    â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚ # 3. Inserir na fila de mensagens                            â”‚         â”‚
â”‚  â”‚ supabase.table('fila_mensagens').insert({                    â”‚         â”‚
â”‚  â”‚   'mensagem_original': mensagem_original,                    â”‚         â”‚
â”‚  â”‚   'mensagem_com_afiliado': mensagem_modificada,              â”‚         â”‚
â”‚  â”‚   'imagem_url': imagem_url_supabase,                         â”‚         â”‚
â”‚  â”‚   'data_agendamento': proxima_data,                          â”‚         â”‚
â”‚  â”‚   'status': 'agendado',                                      â”‚         â”‚
â”‚  â”‚   'grupo_origem': grupo_id                                   â”‚         â”‚
â”‚  â”‚ })                                                            â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“Š Registro na Fila                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ ID: 123                                                       â”‚         â”‚
â”‚  â”‚ Status: agendado                                              â”‚         â”‚
â”‚  â”‚ Agendamento: 2024-11-24 15:30:00                             â”‚         â”‚
â”‚  â”‚ Mensagem: "ğŸ”¥ Oferta TOP! https://mercadolivre.com/sec/..."  â”‚         â”‚
â”‚  â”‚ Links substituÃ­dos: 1                                        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â¬‡ï¸

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ETAPA 7: ENVIO AUTOMÃTICO (scheduler.py)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â° APScheduler - Executa a cada 1 minuto                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ def processar_fila_mensagens():                              â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # 1. Buscar mensagens prontas para envio                   â”‚         â”‚
â”‚  â”‚   mensagens = supabase                                       â”‚         â”‚
â”‚  â”‚     .table('fila_mensagens')                                 â”‚         â”‚
â”‚  â”‚     .select('*')                                             â”‚         â”‚
â”‚  â”‚     .eq('status', 'agendado')                                â”‚         â”‚
â”‚  â”‚     .lte('data_agendamento', datetime.now())                 â”‚         â”‚
â”‚  â”‚     .execute()                                               â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚   # 2. Para cada mensagem, enviar via WhatsApp               â”‚         â”‚
â”‚  â”‚   for msg in mensagens:                                      â”‚         â”‚
â”‚  â”‚     # Buscar grupos configurados para envio automÃ¡tico       â”‚         â”‚
â”‚  â”‚     grupos = buscar_grupos_auto_envio()                      â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚     # Enviar para WhatsApp Monitor                           â”‚         â”‚
â”‚  â”‚     requests.post('http://localhost:3001/send-product', {    â”‚         â”‚
â”‚  â”‚       'groupIds': grupos,                                    â”‚         â”‚
â”‚  â”‚       'message': msg['mensagem_com_afiliado'],               â”‚         â”‚
â”‚  â”‚       'imageUrl': msg['imagem_url']                          â”‚         â”‚
â”‚  â”‚     })                                                        â”‚         â”‚
â”‚  â”‚                                                               â”‚         â”‚
â”‚  â”‚     # 3. Atualizar status                                    â”‚         â”‚
â”‚  â”‚     supabase.table('fila_mensagens')                         â”‚         â”‚
â”‚  â”‚       .update({'status': 'enviado'})                         â”‚         â”‚
â”‚  â”‚       .eq('id', msg['id'])                                   â”‚         â”‚
â”‚  â”‚       .execute()                                             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â¬‡ï¸

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RESULTADO FINAL                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  âœ… Mensagem enviada para grupos configurados                              â”‚
â”‚  âœ… Link de afiliado original visitado (comissÃ£o gerada)                   â”‚
â”‚  âœ… SEU link de afiliado criado e compartilhado                            â”‚
â”‚  âœ… HistÃ³rico salvo no banco de dados                                      â”‚
â”‚  âœ… Logs completos em scraping.log                                         â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“Š MÃ©tricas                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ âœ“ Links detectados: 1                                        â”‚         â”‚
â”‚  â”‚ âœ“ Links expandidos: 1 (100%)                                 â”‚         â”‚
â”‚  â”‚ âœ“ Links de afiliado criados: 1                               â”‚         â”‚
â”‚  â”‚ âœ“ Mensagens agendadas: 1                                     â”‚         â”‚
â”‚  â”‚ âœ“ Mensagens enviadas: 1                                      â”‚         â”‚
â”‚  â”‚ âœ“ Tempo total: ~3 segundos                                   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚  ğŸ‰ CLONAGEM CONCLUÃDA COM SUCESSO!                                        â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
RESUMO DO FLUXO
================================================================================

1. ğŸ“± WhatsApp Monitor detecta mensagem com link /sec/...
2. ğŸ“¤ Envia para Flask via POST /whatsapp/clone-message
3. ğŸ” Flask identifica link curto ML
4. ğŸŒ Acessa link (gera comissÃ£o original) e extrai produto real
5. ğŸ”— Gera SEU link de afiliado via API do ML
6. ğŸ“ Substitui link na mensagem
7. ğŸ’¾ Adiciona Ã  fila de envio automÃ¡tico
8. â° Scheduler envia quando chegar o horÃ¡rio
9. âœ… Mensagem com SEU afiliado enviada aos grupos

TEMPO MÃ‰DIO: 2-3 segundos
TAXA DE SUCESSO: ~95% (com seletores de fallback)

================================================================================
