<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clonagem de Mensagens - Promo Brothers</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-card p {
            color: var(--text-secondary);
            margin: 5px 0 0;
            font-size: 14px;
        }

        .queue-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .queue-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .queue-actions {
            display: flex;
            gap: 10px;
        }

        .queue-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        .queue-item.enviado {
            border-left-color: #10b981;
            opacity: 0.7;
        }

        .queue-item.erro {
            border-left-color: #ef4444;
        }

        .queue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .queue-item-info {
            flex: 1;
        }

        .queue-item-info h4 {
            margin: 0 0 5px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .queue-item-info small {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .queue-item-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .queue-item-status.pendente {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .queue-item-status.enviando {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .queue-item-status.enviado {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .queue-item-status.erro {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .queue-item-message {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--text-secondary);
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .queue-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .queue-item-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .queue-item-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .btn-icon.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .config-section {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .config-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-row label {
            min-width: 200px;
            color: var(--text-secondary);
        }

        .config-row input[type="number"] {
            width: 100px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-tab {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 13px;
        }

        .filter-tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .filter-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            color: white;
        }

        .next-send-banner {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .next-send-banner svg {
            width: 24px;
            height: 24px;
            color: var(--primary);
        }

        .next-send-banner span {
            flex: 1;
        }

        .next-send-banner strong {
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-section">
                <a href="/" class="logo">Promo Brothers</a>
                <span class="version">v4.0</span>
            </div>
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="/whatsapp-monitor">WhatsApp Monitor</a>
                <a href="/whatsapp/clone-page" class="active">Fila de Clonagem</a>
                <a href="/logout" class="btn-logout">Sair</a>
            </nav>
        </header>

        <main>
            <h1>Fila de Mensagens Clonadas</h1>
            <p class="subtitle">Gerencie mensagens clonadas com links de afiliado para envio automatico</p>

            <!-- Estatisticas -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="stat-pendentes">0</h3>
                    <p>Pendentes</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-enviadas">0</h3>
                    <p>Enviadas</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-erros">0</h3>
                    <p>Com Erro</p>
                </div>
            </div>

            <!-- Proximo Envio -->
            <div class="next-send-banner" id="next-send-banner" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Proximo envio agendado para: <strong id="next-send-time">--</strong></span>
            </div>

            <!-- Configuracoes -->
            <div class="config-section">
                <h3>Configuracoes</h3>
                <div class="config-row">
                    <label>Intervalo entre envios (minutos):</label>
                    <input type="number" id="intervalo-minutos" min="1" max="60" value="5">
                    <button class="btn btn-primary" onclick="salvarIntervalo()">Salvar</button>
                </div>
                <div class="config-row">
                    <label>Acoes rapidas:</label>
                    <button class="btn btn-secondary" onclick="processarFilaAgora()">Processar Fila Agora</button>
                    <button class="btn btn-danger" onclick="limparFilaEnviadas()">Limpar Enviadas</button>
                </div>
            </div>

            <!-- Fila de Mensagens -->
            <div class="queue-card">
                <div class="queue-header">
                    <h2>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        Fila de Envio
                    </h2>
                    <div class="queue-actions">
                        <button class="btn btn-secondary" onclick="carregarFila()">Atualizar</button>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="filter-tabs">
                    <button class="filter-tab active" data-status="todos" onclick="filtrarFila('todos', this)">Todos</button>
                    <button class="filter-tab" data-status="pendente" onclick="filtrarFila('pendente', this)">Pendentes</button>
                    <button class="filter-tab" data-status="enviado" onclick="filtrarFila('enviado', this)">Enviados</button>
                    <button class="filter-tab" data-status="erro" onclick="filtrarFila('erro', this)">Com Erro</button>
                </div>

                <!-- Lista -->
                <div id="queue-list">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                        <p>Nenhuma mensagem na fila</p>
                        <small>Clone mensagens do WhatsApp Monitor para adicionar aqui</small>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let statusAtual = 'todos';

        // Carregar dados iniciais
        document.addEventListener('DOMContentLoaded', () => {
            carregarEstatisticas();
            carregarFila();

            // Atualizar a cada 30 segundos
            setInterval(() => {
                carregarEstatisticas();
                carregarFila();
            }, 30000);
        });

        async function carregarEstatisticas() {
            try {
                const response = await fetch('/fila-mensagens/estatisticas');
                const data = await response.json();

                if (data.success !== false) {
                    document.getElementById('stat-pendentes').textContent = data.pendentes || 0;
                    document.getElementById('stat-enviadas').textContent = data.enviadas || 0;
                    document.getElementById('stat-erros').textContent = data.erros || 0;

                    if (data.proximo_envio) {
                        document.getElementById('next-send-banner').style.display = 'flex';
                        document.getElementById('next-send-time').textContent = data.proximo_envio;
                    } else {
                        document.getElementById('next-send-banner').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar estatisticas:', error);
            }
        }

        async function carregarFila() {
            try {
                const response = await fetch(`/fila-mensagens?status=${statusAtual}`);
                const data = await response.json();

                const container = document.getElementById('queue-list');

                if (!data.success || !data.mensagens || data.mensagens.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            <p>Nenhuma mensagem na fila</p>
                            <small>Clone mensagens do WhatsApp Monitor para adicionar aqui</small>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.mensagens.map(msg => `
                    <div class="queue-item ${msg.status}">
                        <div class="queue-item-header">
                            <div class="queue-item-info">
                                <h4>${msg.grupo_origem_nome || 'Grupo desconhecido'}</h4>
                                <small>ID: ${msg.id}</small>
                            </div>
                            <span class="queue-item-status ${msg.status}">${msg.status}</span>
                        </div>
                        <div class="queue-item-message">${escapeHtml(msg.mensagem_com_afiliado || msg.mensagem_original || '').substring(0, 300)}${(msg.mensagem_com_afiliado || '').length > 300 ? '...' : ''}</div>
                        <div class="queue-item-footer">
                            <span class="queue-item-time">
                                Agendado: ${msg.agendamento_envio || 'N/A'}
                                ${msg.enviado_em ? ' | Enviado: ' + msg.enviado_em : ''}
                            </span>
                            <div class="queue-item-actions">
                                <button class="btn-icon delete" onclick="deletarMensagem(${msg.id})" title="Remover">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erro ao carregar fila:', error);
            }
        }

        function filtrarFila(status, btn) {
            statusAtual = status;

            // Atualizar botoes
            document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            carregarFila();
        }

        async function deletarMensagem(id) {
            if (!confirm('Remover esta mensagem da fila?')) return;

            try {
                const response = await fetch(`/fila-mensagens/${id}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    carregarFila();
                    carregarEstatisticas();
                } else {
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao deletar:', error);
                alert('Erro ao deletar mensagem');
            }
        }

        async function salvarIntervalo() {
            const intervalo = document.getElementById('intervalo-minutos').value;

            try {
                const response = await fetch('/fila-mensagens/configurar-intervalo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ intervalo_minutos: parseInt(intervalo) })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Intervalo salvo com sucesso!');
                } else {
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar configuracao');
            }
        }

        async function processarFilaAgora() {
            if (!confirm('Processar todas as mensagens pendentes agora?')) return;

            try {
                const response = await fetch('/fila-mensagens/processar-agora', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert(`Processado! ${data.processadas} mensagens enviadas, ${data.erros} erros.`);
                    carregarFila();
                    carregarEstatisticas();
                } else {
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao processar:', error);
                alert('Erro ao processar fila');
            }
        }

        async function limparFilaEnviadas() {
            if (!confirm('Remover todas as mensagens ja enviadas?')) return;

            try {
                const response = await fetch('/fila-mensagens/limpar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dias: 0 })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`${data.deletados || 0} mensagens removidas!`);
                    carregarFila();
                    carregarEstatisticas();
                } else {
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao limpar:', error);
                alert('Erro ao limpar fila');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
